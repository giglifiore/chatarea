<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat por Zona üåé</title>
<style>
  /* ===== Reset y tipograf√≠a ===== */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 10px; color: #333; }

  /* ===== Chat P√∫blico ===== */
  h2 { margin-bottom: 10px; color: #1a73e8; text-align: center; }
  #chat-box-container { margin-bottom: 20px; background:#fff; border-radius:12px; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  #chat-box { height: 250px; overflow-y: auto; border-radius: 10px; border: 1px solid #ccc; padding: 10px; background: #fff; }
  #status { margin: 8px 0; font-weight: bold; color: #4caf50; text-align:center; }

  input, select, button { padding: 8px 10px; margin:5px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; }
  button { cursor:pointer; background:#1a73e8; color:white; border:none; transition:0.2s; }
  button:hover { background:#155ab6; }

  #controls { display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; margin-bottom:10px; }

  /* ===== Chats Privados ===== */
  #private-chats { margin-top: 20px; }
  #private-chats h3 { color:#1a73e8; margin-bottom:10px; text-align:center; }
  #private-tabs { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; justify-content:center; }
  .private-tab { position:relative; background:#e8f0ff; padding:6px 12px; border-radius:8px; cursor:pointer; font-weight:500; transition:0.2s; }
  .private-tab:hover { background:#d2e3fc; }
  .private-tab.active { background:#1a73e8; color:white; }

  .close-btn { position:absolute; top:-6px; right:-6px; width:18px; height:18px; border-radius:50%; background:red; color:white; border:none; font-size:12px; cursor:pointer; line-height:16px; }

  #private-boxes { display:flex; flex-direction:column; gap:10px; }
  .private-chat { display:none; background:#fff; border-radius:10px; padding:10px; border:1px solid #ccc; max-height:250px; overflow-y:auto; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .private-chat.active { display:block; }

  .private-chat input { width:70%; margin-right:5px; border-radius:6px; border:1px solid #ccc; padding:6px 10px; }
  .private-chat button { padding:6px 12px; border-radius:6px; background:#1a73e8; color:white; border:none; cursor:pointer; }
  .private-chat button:hover { background:#155ab6; }

  #chat-box::-webkit-scrollbar, .private-chat::-webkit-scrollbar { width:8px; }
  #chat-box::-webkit-scrollbar-thumb, .private-chat::-webkit-scrollbar-thumb { background:#c1c1c1; border-radius:4px; }
  #chat-box::-webkit-scrollbar-track, .private-chat::-webkit-scrollbar-track { background:#f1f1f1; border-radius:4px; }

  #chat-box div, .private-chat div { margin-bottom:6px; padding:4px 6px; border-radius:6px; background:#f1f3f5; }
  #chat-box div button { padding:2px 6px; font-size:12px; margin-left:6px; background:#1a73e8; border-radius:4px; }
  #chat-box div button:hover { background:#155ab6; color:white; }

  @media(max-width:600px){
    #chat-box{height:200px;}
    .private-chat{max-height:180px;}
    input, select, button{font-size:13px;}
  }
</style>
</head>
<body>

<h2>Chat P√∫blico por Zona üåé</h2>

<div id="chat-box-container">
  <div id="controls">
    <select id="radius">
      <option value="1">1 km</option>
      <option value="5">5 km</option>
      <option value="10">10 km</option>
      <option value="50">50 km</option>
    </select>

    <select id="gender-select">
      <option value="M">‚ôÇÔ∏è M</option>
      <option value="F">‚ôÄÔ∏è F</option>
      <option value="O">‚öß Otro</option>
    </select>

    <input type="text" id="nickname" placeholder="Tu nick...">
  </div>

  <div id="status">Conectando...</div>
  <div id="chat-box"></div>

  <input type="text" id="message" placeholder="Escribe un mensaje...">
  <button id="send">Enviar</button>
</div>

<div id="private-chats">
  <h3>Chats Privados üí¨</h3>
  <div id="private-tabs"></div>
  <div id="private-boxes"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
  authDomain: "chatarea-6170e.firebaseapp.com",
  projectId: "chatarea-6170e",
  storageBucket: "chatarea-6170e.firebasestorage.app",
  messagingSenderId: "147913199399",
  appId: "1:147913199399:web:886f09ab74017b3fc22302",
  databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let userLat=0, userLon=0, chatRadius=1;
const chatBox=document.getElementById("chat-box");
const input=document.getElementById("message");
const sendBtn=document.getElementById("send");
const radiusSelect=document.getElementById("radius");
const genderSelect=document.getElementById("gender-select");
const nickInput=document.getElementById("nickname");
const privateTabs=document.getElementById("private-tabs");
const privateBoxes=document.getElementById("private-boxes");
let currentUser=null;
const privateChats={};

auth.signInAnonymously().then(()=>{
  currentUser=auth.currentUser;
  const userRef=db.ref("usuarios/"+currentUser.uid);
  document.getElementById("status").innerText="Autenticado ‚úÖ";

  nickInput.addEventListener("change", ()=>userRef.update({nick:nickInput.value}));
  genderSelect.addEventListener("change", ()=>userRef.update({genero:genderSelect.value}));
  radiusSelect.addEventListener("change", ()=>{chatRadius=parseFloat(radiusSelect.value); userRef.update({radio:chatRadius})});

  userRef.once("value").then(snap=>{
    const data=snap.val()||{};
    if(data.nick) nickInput.value=data.nick;
    if(data.genero) genderSelect.value=data.genero;
    if(data.radio) { chatRadius=data.radio; radiusSelect.value=chatRadius; }
    initLocation();
    listenPrivateChats();
  });
});

function initLocation(){
  if(!navigator.geolocation){ alert("No soporta geolocalizaci√≥n"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    userLat=pos.coords.latitude; userLon=pos.coords.longitude;
    document.getElementById("status").innerText+=" | Ubicaci√≥n activa";
    listenMessages();
  });
}

sendBtn.onclick=()=>{
  const text=input.value.trim(); if(!text) return;
  const nick=nickInput.value.trim()||"Anon";
  db.ref("mensajes").push({text,timestamp:Date.now(),uid:currentUser.uid,nick,lat:userLat,lon:userLon,gender:genderSelect.value});
  input.value="";
};

function listenMessages(){
  const ref=db.ref("mensajes").orderByChild("timestamp");
  ref.off();
  ref.on("child_added",snap=>{
    const msg=snap.val();
    const dist=getDistance(userLat,userLon,msg.lat,msg.lon);
    if(dist<=chatRadius){
      const dateStr=new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      const icon=msg.gender==='M'?'‚ôÇÔ∏è':msg.gender==='F'?'‚ôÄÔ∏è':'‚öß';
      const div=document.createElement("div");
      div.textContent=`[${dateStr}] ${icon} ${msg.nick}: ${msg.text} (${dist.toFixed(1)} km)`;
      if(msg.uid!==currentUser.uid){
        const btn=document.createElement("button"); btn.textContent="Privado";
        btn.onclick=()=>openPrivateChat(msg.uid,msg.nick);
        div.appendChild(btn);
      }
      chatBox.appendChild(div); chatBox.scrollTop=chatBox.scrollHeight;
    }
  });
}

function getDistance(lat1,lon1,lat2,lon2){
  const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function listenPrivateChats(){
  db.ref("chatsPrivados").on("child_added",snap=>{
    const chatId=snap.key;
    if(chatId.includes(currentUser.uid)){
      const otherUid=chatId.replace(currentUser.uid,'').replace('_','');
      openPrivateChat(otherUid);
    }
  });
}

function openPrivateChat(otherUid,otherNick){
  const chatId=[currentUser.uid,otherUid].sort().join("_");
  if(privateChats[chatId]) { showChat(chatId); return; }

  const tab=document.createElement("div");
  tab.className="private-tab";
  tab.textContent=otherNick||otherUid;

  const closeBtn=document.createElement("button");
  closeBtn.className="close-btn"; closeBtn.textContent="√ó";
  closeBtn.addEventListener("click", e=>{
    e.stopPropagation();
    privateBoxes.removeChild(privateChats[chatId].box);
    privateTabs.removeChild(tab);
    delete privateChats[chatId];
  });

  tab.appendChild(closeBtn);
  tab.addEventListener("click", ()=>showChat(chatId));
  privateTabs.appendChild(tab);

  const box=document.createElement("div"); box.className="private-chat active";
  privateBoxes.appendChild(box);

  const msgBox=document.createElement("div"); msgBox.style.flex="1"; msgBox.style.overflowY="auto"; box.appendChild(msgBox);

  const inputContainer=document.createElement("div"); inputContainer.style.display="flex"; inputContainer.style.gap="5px";
  const inputP=document.createElement("input"); inputP.placeholder="Mensaje...";
  const btnP=document.createElement("button"); btnP.textContent="Enviar";
  inputContainer.appendChild(inputP); inputContainer.appendChild(btnP);
  box.appendChild(inputContainer);

  btnP.addEventListener("click", ()=>{
    if(inputP.value.trim()){
      db.ref("chatsPrivados/"+chatId).push({
        uid:currentUser.uid,
        nick:nickInput.value||"Anon",
        text:inputP.value.trim(),
        timestamp:Date.now()
      });
      inputP.value="";
    }
  });

  const ref=db.ref("chatsPrivados/"+chatId).orderByChild("timestamp");
  ref.on("child_added", snap=>{
    const m=snap.val();
    const d=document.createElement("div");
    const dateStr=new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    d.textContent=`[${dateStr}] ${m.nick||"Anon"}: ${m.text}`;
    msgBox.appendChild(d);
    msgBox.scrollTop=msgBox.scrollHeight;
  });

  privateChats[chatId]={tab,box};
  showChat(chatId);
}

function showChat(chatId){
  Object.values(privateChats).forEach(c=>{
    c.box.classList.remove("active");
    c.tab.classList.remove("active");
  });
  privateChats[chatId].box.classList.add("active");
  privateChats[chatId].tab.classList.add("active");
}
</script>

</body>
</html>
