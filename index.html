<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>La Chismosa üåé</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body, input, textarea, select, button {
    font-family: 'Segoe UI', 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', 'Twemoji Mozilla', Tahoma, Geneva, Verdana, sans-serif;
  }

  h2 { text-align: center; color: #1a73e8; margin-bottom: 10px; }

  #chat-box-container { background: #fff; border-radius: 12px; padding: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  #chat-box { height: 300px; overflow-y: auto; border-radius: 10px; border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; background: #fff; }
  #status { text-align: center; font-weight: bold; color: #4caf50; margin-bottom: 10px; }

  #controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
  #controls select, #controls input { flex: 1; min-width: 80px; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
  #controls label { font-weight: 500; margin-right: 5px; }

  #message-container { display: flex; align-items: center; gap: 5px; margin-bottom: 8px; }
  #message { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
  #emojiPicker { cursor:pointer; font-size:20px; }
  #send { padding: 10px; border-radius: 6px; border: none; background: #1a73e8; color: white; cursor: pointer; }
  #send:hover { background: #155ab6; }

  /* Chats privados */
  #private-chats { margin-top: 20px; }
  #private-chats h3 { color: #1a73e8; text-align: center; margin-bottom: 10px; }

  #private-tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
  .private-tab { position: relative; padding: 6px 12px; border-radius: 8px; background: #e8f0ff; cursor: pointer; font-weight: 500; transition: 0.2s; }
  .private-tab.active { background: #1a73e8; color: white; }
  .private-tab:hover { background: #d2e3fc; }
  .private-tab.has-new { background: #ff4d4f; color: white; }
  .private-tab.has-new:hover { background: #e64545; }

  .close-btn {
    position: absolute; top: -6px; right: -6px;
    width: 18px; height: 18px; border-radius: 50%;
    background: red; color: white; border: none;
    font-size: 12px; cursor: pointer; line-height: 16px;
  }

  #private-boxes { display: flex; flex-direction: column; gap: 10px; }
  .private-chat { display: none; flex-direction: column; background: #fff; border-radius: 10px; padding: 10px; border: 1px solid #ccc; max-height: 250px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .private-chat.active { display: flex; }
  .private-chat input { flex: 1; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
  .private-chat button { padding: 6px 12px; border-radius: 6px; border: none; background: #1a73e8; color: white; cursor: pointer; }
  .private-chat button:hover { background: #155ab6; }

  /* Mensajes */
  #chat-box div, .private-chat div.message { margin-bottom: 6px; padding: 4px 6px; border-radius: 6px; background: #f1f3f5; word-wrap: break-word; }
  #chat-box div button { padding: 2px 6px; font-size: 12px; margin-left: 6px; background: #1a73e8; border-radius: 4px; border: none; color: white; cursor: pointer; }
  #chat-box div button:hover { background: #155ab6; }

  /* Scroll moderno */
  #chat-box::-webkit-scrollbar, .private-chat::-webkit-scrollbar { width: 6px; }
  #chat-box::-webkit-scrollbar-thumb, .private-chat::-webkit-scrollbar-thumb { background: #bbb; border-radius: 4px; }
  #chat-box::-webkit-scrollbar-thumb:hover, .private-chat::-webkit-scrollbar-thumb:hover { background: #999; }

  /* Men√∫ emojis */
  .emoji-menu {
    max-height: 150px;
    overflow-y: auto;
    padding: 5px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
    position: absolute;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  .emoji-menu span { cursor:pointer; font-size:20px; text-align:center; }
</style>
</head>
<body>

<h2>La Chismosa üåé</h2>

<div id="chat-box-container">
  <div id="controls">
    <label for="radius">Radio:</label>
    <select id="radius">
      <option value="0.5">0.5 km</option>
      <option value="1">1 km</option>
      <option value="5">5 km</option>
      <option value="10">10 km</option>
      <option value="50">50 km</option>
    </select>

    <label for="gender">G√©nero:</label>
    <select id="gender-select">
      <option value="M">‚ôÇÔ∏è M</option>
      <option value="F">‚ôÄÔ∏è F</option>
      <option value="O">‚öß Otro</option>
    </select>

    <label for="nickname">Nick:</label>
    <input type="text" id="nickname" placeholder="Tu apodo">
  </div>

  <div id="status">Conectando...</div>
  <div id="chat-box"></div>

  <div id="message-container">
    <input type="text" id="message" maxlength="50" placeholder="Escribe un mensaje (m√°x 50 caracteres)...">
    <span id="emojiPicker">üòä</span>
    <button id="send">Enviar</button>
  </div>
</div>

<div id="private-chats">
  <h3>Chats Privados üí¨</h3>
  <div id="private-tabs"></div>
  <div id="private-boxes"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
  authDomain: "chatarea-6170e.firebaseapp.com",
  projectId: "chatarea-6170e",
  storageBucket: "chatarea-6170e.firebasestorage.app",
  messagingSenderId: "147913199399",
  appId: "1:147913199399:web:886f09ab74017b3fc22302",
  databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let userLat = 0, userLon = 0, chatRadius = 1.0;
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("message");
const sendBtn = document.getElementById("send");
const radiusSelect = document.getElementById("radius");
const genderSelect = document.getElementById("gender-select");
const nickInput = document.getElementById("nickname");
const privateTabs = document.getElementById("private-tabs");
const privateBoxes = document.getElementById("private-boxes");
const emojiPicker = document.getElementById("emojiPicker");
let currentUser = null;
const privateChats = {};
const messageTimestamps = {};
const MAX_MESSAGES = 5;
const TIME_WINDOW = 10000;

// üö´ Palabras prohibidas
const badWords = [
  "puta","puto","pendejo","cabron","co√±o","mierda","maldito","idiota",
  "fuck","shit","bitch","asshole","stupid","dumbass","imbecil","perra"
];

function cleanBadWords(text) {
  let result = text;
  badWords.forEach(w => {
    const regex = new RegExp("\\b" + w + "\\b", "gi");
    result = result.replace(regex, "****");
  });
  return result;
}

// üïí Anti-spam
function canSendMessage(uid) {
  const now = Date.now();
  if (!messageTimestamps[uid]) messageTimestamps[uid] = [];
  messageTimestamps[uid] = messageTimestamps[uid].filter(t => now - t < TIME_WINDOW);
  if (messageTimestamps[uid].length >= MAX_MESSAGES) return false;
  messageTimestamps[uid].push(now);
  return true;
}

// üî• Autenticaci√≥n y presencia
auth.signInAnonymously().then(() => {
  currentUser = auth.currentUser;
  const userRef = db.ref("usuarios/" + currentUser.uid);
  document.getElementById("status").innerText = "Autenticado ‚úÖ";

  // Presencia (online/offline)
  const userStatusRef = db.ref("usuarios/" + currentUser.uid + "/online");
  const connectedRef = db.ref(".info/connected");
  connectedRef.on("value", snap => {
    if (snap.val() === false) return;
    userStatusRef.onDisconnect().set(false);
    userStatusRef.set(true);
  });

  nickInput.addEventListener("change", () => userRef.update({ nick: nickInput.value.trim() }));
  radiusSelect.addEventListener("change", () => userRef.update({ radio: radiusSelect.value }));
  genderSelect.addEventListener("change", () => userRef.update({ genero: genderSelect.value }));

  userRef.once("value").then(snapshot => {
    const data = snapshot.val() || {};
    if (data.radio) { chatRadius = data.radio; radiusSelect.value = chatRadius; }
    if (data.genero) genderSelect.value = data.genero;
    if (data.nick) nickInput.value = data.nick;
    initLocation();
    listenPrivateChats();
  });
});

function initLocation() {
  if (!navigator.geolocation) { alert("Tu navegador no soporta geolocalizaci√≥n."); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    userLat = pos.coords.latitude;
    userLon = pos.coords.longitude;
    document.getElementById("status").innerText += " | Ubicaci√≥n activa üìç";
    listenMessages();
  });
}

// ‚úâÔ∏è Enviar mensaje p√∫blico
function sendPublicMessage() {
  let text = input.value.trim();
  if (!text) return;
  if (text.length > 50) { alert("El mensaje no puede superar los 50 caracteres."); return; }

  text = cleanBadWords(text);

  if (!canSendMessage(currentUser.uid)) {
    alert("Est√°s enviando mensajes demasiado r√°pido. Espera unos segundos ‚è≥");
    return;
  }

  const nick = nickInput.value.trim() || "Anon";
  db.ref("mensajes").push({
    text,
    timestamp: Date.now(),
    uid: currentUser.uid,
    nick,
    lat: userLat,
    lon: userLon,
    gender: genderSelect.value
  });
  input.value = "";
}
sendBtn.addEventListener("click", sendPublicMessage);
input.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); sendPublicMessage(); } });

// üëÇ Escuchar mensajes
function listenMessages() {
  const ref = db.ref("mensajes").orderByChild("timestamp");
  ref.off();
  ref.on("child_added", snap => {
    const msg = snap.val();
    const dist = getDistance(userLat, userLon, msg.lat, msg.lon);
    if (dist <= chatRadius) {
      const dateStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const icon = msg.gender === 'M' ? '‚ôÇÔ∏è' : msg.gender === 'F' ? '‚ôÄÔ∏è' : '‚öß';
      const div = document.createElement("div");
      div.style.display = "flex";
      div.style.alignItems = "center";
      div.style.justifyContent = "space-between";
      div.style.background = "#fff";
      div.style.borderRadius = "8px";
      div.style.padding = "6px 10px";
      div.style.margin = "4px 0";
      div.style.boxShadow = "0 1px 2px rgba(0,0,0,0.05)";
      const msgText = document.createElement("span");
      msgText.style.flex = "1";

      // Estado online
      const userStatus = db.ref("usuarios/" + msg.uid + "/online");
      userStatus.on("value", s => {
        const online = s.val();
        const statusDot = online ? "üü¢" : "‚ö´";
        msgText.textContent = `${statusDot} ${icon} ${msg.nick || "Anon"}: ${msg.text} (${dist.toFixed(1)} km)`;
      });

      const timeSpan = document.createElement("span");
      timeSpan.textContent = dateStr;
      timeSpan.style.fontSize = "11px";
      timeSpan.style.color = "#999";
      timeSpan.style.marginLeft = "10px";

      div.appendChild(msgText);
      div.appendChild(timeSpan);

      if (msg.uid !== currentUser.uid) {
        const btn = document.createElement("button");
        btn.textContent = "Privado";
        btn.onclick = () => openPrivateChat(msg.uid, msg.nick);
        btn.style.marginLeft = "8px";
        div.appendChild(btn);
      }

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  });
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180)
    * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// üí¨ Chats privados
function listenPrivateChats() {
  const ref = db.ref("chatsPrivados");
  ref.on("child_added", snap => {
    const chatId = snap.key;
    if (chatId.includes(currentUser.uid) && !privateChats[chatId]) {
      const otherUid = chatId.replace(currentUser.uid, '').replace('_', '');
      db.ref("usuarios/" + otherUid).once("value").then(snapNick => {
        const otherNick = snapNick.val()?.nick || otherUid;
        createPrivateChat(chatId, otherUid, otherNick);
      });
    }
  });
}

function openPrivateChat(otherUid, otherNick) {
  const chatId = [currentUser.uid, otherUid].sort().join("_");
  if (!privateChats[chatId]) {
    createPrivateChat(chatId, otherUid, otherNick);
  }
  showPrivateChat(chatId);
}

function createPrivateChat(chatId, otherUid, otherNick) {
  const tab = document.createElement("button");
  tab.textContent = otherNick;
  tab.onclick = () => showPrivateChat(chatId);
  privateTabs.appendChild(tab);

  const box = document.createElement("div");
  box.classList.add("private-chat");
  box.style.display = "none";

  const messagesDiv = document.createElement("div");
  messagesDiv.classList.add("messages");

  const inputDiv = document.createElement("div");
  inputDiv.classList.add("input-area");

  const inputField = document.createElement("input");
  inputField.placeholder = "Escribe un mensaje privado...";

  const sendButton = document.createElement("button");
  sendButton.textContent = "Enviar";
  sendButton.onclick = () => {
    const text = cleanBadWords(inputField.value.trim());
    if (!text) return;
    if (!canSendMessage(currentUser.uid)) {
      alert("Demasiados mensajes seguidos. Espera un poco ‚è≥");
      return;
    }
    db.ref("chatsPrivados/" + chatId).push({
      text,
      timestamp: Date.now(),
      from: currentUser.uid
    });
    inputField.value = "";
  };

  inputDiv.appendChild(inputField);
  inputDiv.appendChild(sendButton);
  box.appendChild(messagesDiv);
  box.appendChild(inputDiv);
  privateBoxes.appendChild(box);

  privateChats[chatId] = { box, messagesDiv };

  db.ref("chatsPrivados/" + chatId).on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    const dateStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    div.textContent = `[${dateStr}] ${msg.from === currentUser.uid ? "T√∫" : otherNick}: ${msg.text}`;
    div.style.fontSize = "13px";
    div.style.color = msg.from === currentUser.uid ? "#444" : "#000";
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

function showPrivateChat(chatId) {
  document.querySelectorAll(".private-chat").forEach(b => b.style.display = "none");
  if (privateChats[chatId]) privateChats[chatId].box.style.display = "block";
}

// üòä Picker de emojis
emojiPicker.addEventListener("click", () => {
  const emojis = "üòÄüòÅüòÇü§£üòÉüòÑüòÖüòÜüòâüòäüòçüòòüòéü§©ü§îüò¢üò≠üò°üòáüôàüôâüôäüëçüëéüëèüôèüí™üî•‚ù§Ô∏èüíîüíãüéâüíØ";
  const menu = document.createElement("div");
  menu.style.position = "absolute";
  menu.style.background = "#fff";
  menu.style.border = "1px solid #ccc";
  menu.style.borderRadius = "8px";
  menu.style.padding = "5px";
  menu.style.display = "grid";
  menu.style.gridTemplateColumns = "repeat(8,1fr)";
  menu.style.gap = "4px";
  menu.style.zIndex = 1000;
  menu.style.top = (emojiPicker.offsetTop - 210) + "px";
  menu.style.left = emojiPicker.offsetLeft + "px";

  emojis.split("").forEach(e => {
    const span = document.createElement("span");
    span.textContent = e;
    span.style.cursor = "pointer";
    span.onclick = () => {
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value = input.value.slice(0, start) + e + input.value.slice(end);
      input.focus();
      input.selectionStart = input.selectionEnd = start + 1;
      menu.remove();
    };
    menu.appendChild(span);
  });
  document.body.appendChild(menu);
  document.addEventListener("click", ev => {
    if (!menu.contains(ev.target) && ev.target !== emojiPicker) menu.remove();
  }, { once: true });
});
</script>



</body>
</html>
