<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat por Zona 🌎</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    #status { color: green; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Chat Público por Zona 🌎</h2>
  <div id="status">Conectando...</div>
  <div id="chat-box"></div>
  <input type="text" id="message" placeholder="Escribe un mensaje..." />
  <button id="send">Enviar</button>

  <!-- Firebase SDK compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <script>
    // 🔧 Tu configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
      authDomain: "chatarea-6170e.firebaseapp.com",
      projectId: "chatarea-6170e",
      storageBucket: "chatarea-6170e.firebasestorage.app",
      messagingSenderId: "147913199399",
      appId: "1:147913199399:web:886f09ab74017b3fc22302",
      measurementId: "G-RECZQ87BG4",
      databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com" // ✅ importante
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userLat = 0, userLon = 0;
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("send");

    // 🔐 Login anónimo
    auth.signInAnonymously()
      .then(() => {
        document.getElementById("status").innerText = "Autenticado anónimamente ✅";
        initLocation();
      })
      .catch(err => alert("Error al autenticar: " + err.message));

    // 📍 Obtener ubicación del usuario
    function initLocation() {
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalización");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        document.getElementById("status").innerText +=
          ` | Ubicación detectada (${userLat.toFixed(3)}, ${userLon.toFixed(3)})`;
        listenMessages();
      }, err => alert("Error de ubicación: " + err.message));
    }

    // ✉️ Enviar mensaje
    sendBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;

      const msg = {
        text,
        timestamp: Date.now(),
        uid: auth.currentUser ? auth.currentUser.uid : "anon",
        lat: userLat,
        lon: userLon
      };

      db.ref("mensajes").push(msg);
      input.value = "";
    });

    // 💬 Escuchar mensajes y mostrar solo los cercanos (1 km)
    function listenMessages() {
      const mensajesRef = db.ref("mensajes");
      mensajesRef.off(); // evitar duplicados
      mensajesRef.on("child_added", snap => {
        const msg = snap.val();
        const dist = getDistance(userLat, userLon, msg.lat, msg.lon);
        if (dist <= 1.0) { // mostrar solo mensajes dentro de 1 km
          const div = document.createElement("div");
          div.textContent = `${msg.text} (${dist.toFixed(2)} km)`;
          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });
    }

    // 📏 Función para calcular distancia en km
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // radio de la Tierra en km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
  </script>
</body>
</html>
