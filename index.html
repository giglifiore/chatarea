<!DOCTYPE html>
<html>
<head>
  <title>Chat PÃºblico y Privado</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f4f4f4;
      margin: 20px;
    }

    #publicChat, #privateChats {
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }

    #messages {
      height: 200px;
      overflow-y: scroll;
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
    }

    .privateBox {
      border: 1px solid #aaa;
      border-radius: 8px;
      margin: 5px 0;
      padding: 8px;
      background: #fafafa;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .privateHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      background: #007bff;
      color: white;
      padding: 5px 8px;
      border-radius: 6px 6px 0 0;
    }

    .privateMessages {
      height: 150px;
      overflow-y: auto;
      background: white;
      padding: 5px;
      border-radius: 0 0 6px 6px;
      border: 1px solid #ddd;
    }

    .closeBtn {
      cursor: pointer;
      color: white;
      background: red;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 12px;
    }
  </style>
</head>
<body>

  <h2>ðŸ’¬ Chat PÃºblico</h2>
  <div id="publicChat">
    <div id="messages"></div>
    <input id="nickname" placeholder="Tu nick..." />
    <input id="messageInput" placeholder="Escribe un mensaje..." />
    <button id="btnSend">Enviar</button>
  </div>

  <h2>ðŸ”’ Chats Privados</h2>
  <div id="privateChats"></div>

  <script>
    // âœ… ConfiguraciÃ³n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA8W-V0Ky5jCHuYFpoeTV4rUyy0CEg4iGc",
      authDomain: "chatarea-6170e.firebaseapp.com",
      databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com/",
      projectId: "chatarea-6170e",
      storageBucket: "chatarea-6170e.appspot.com",
      messagingSenderId: "147913199399",
      appId: "1:147913199399:web:886f09a77b83ae1efc0ae4"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const messagesRef = db.ref("publicMessages");
    const privateChatsRef = db.ref("privateMessages");

    const messagesDiv = document.getElementById("messages");
    const btnSend = document.getElementById("btnSend");
    const inputMessage = document.getElementById("messageInput");
    const nicknameInput = document.getElementById("nickname");
    const privateChatsDiv = document.getElementById("privateChats");

    // âœ… Mostrar mensajes pÃºblicos
    messagesRef.on("child_added", snapshot => {
      const msg = snapshot.val();
      const p = document.createElement("p");
      p.textContent = `${msg.nick}: ${msg.text}`;
      p.style.cursor = "pointer";

      // Al hacer clic, abre chat privado
      p.onclick = () => openPrivateChat(msg.nick);
      messagesDiv.appendChild(p);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // âœ… Enviar mensaje pÃºblico
    btnSend.onclick = () => {
      const text = inputMessage.value.trim();
      const nick = nicknameInput.value.trim() || "AnÃ³nimo";

      if (text !== "") {
        messagesRef.push({ nick, text });
        inputMessage.value = "";
      }
    };

    // âœ… Diccionario de chats privados abiertos
    const openChats = {};

    function openPrivateChat(userNick) {
      if (openChats[userNick]) return; // ya estÃ¡ abierto

      const box = document.createElement("div");
      box.className = "privateBox";
      box.innerHTML = `
        <div class="privateHeader">
          <span>Chat con ${userNick}</span>
          <button class="closeBtn">X</button>
        </div>
        <div class="privateMessages" id="chat_${userNick}"></div>
        <input placeholder="Escribe a ${userNick}..." class="privateInput" />
        <button class="sendPrivateBtn">Enviar</button>
      `;

      privateChatsDiv.appendChild(box);
      openChats[userNick] = box;

      const closeBtn = box.querySelector(".closeBtn");
      closeBtn.onclick = () => {
        box.remove();
        delete openChats[userNick];
      };

      const input = box.querySelector(".privateInput");
      const sendBtn = box.querySelector(".sendPrivateBtn");
      const msgContainer = box.querySelector(".privateMessages");

      // Mostrar mensajes privados
      privateChatsRef.child(userNick).on("child_added", snap => {
        const msg = snap.val();
        const p = document.createElement("p");
        p.textContent = `${msg.from}: ${msg.text}`;
        msgContainer.appendChild(p);
        msgContainer.scrollTop = msgContainer.scrollHeight;
      });

      // Enviar mensaje privado
      sendBtn.onclick = () => {
        const text = input.value.trim();
        const nick = nicknameInput.value.trim() || "AnÃ³nimo";
        if (text === "") return;

        privateChatsRef.child(userNick).push({
          from: nick,
          text
        });
        input.value = "";
      };
    }
  </script>
</body>
</html>
