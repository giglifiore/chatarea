<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat por Zona üåé</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    #status { color: green; margin-bottom: 10px; }
    #private-container { margin-top: 20px; border-top: 2px solid #007bff; padding-top: 10px; }
    #private-tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .tab {
      background: #007bff; color: white; padding: 5px 10px; border-radius: 8px;
      cursor: pointer; display: flex; align-items: center;
    }
    .tab.active { background: #0056b3; }
    .tab span { margin-left: 8px; color: #ffcccc; cursor: pointer; }
    .private-chat-box {
      display: none; border: 1px solid #007bff; padding: 10px; height: 200px; overflow-y: auto;
    }
    .private-input { width: 70%; }
  </style>
</head>
<body>
  <h2>Chat P√∫blico por Zona üåé</h2>
  
  <label for="radius">Radio de visibilidad:</label>
  <select id="radius">
    <option value="1">1 km</option>
    <option value="5">5 km</option>
    <option value="10">10 km</option>
    <option value="50">50 km</option>
  </select>

  <br>
  <label for="gender">G√©nero:</label>
  <select id="gender-select">
    <option value="M">‚ôÇÔ∏è Masculino</option>
    <option value="F">‚ôÄÔ∏è Femenino</option>
    <option value="O">‚öß Otro</option>
  </select>
  
  <br>
  <label for="nickname">Nick:</label>
  <input type="text" id="nickname" placeholder="Tu apodo" />

  <div id="status">Conectando...</div>
  <div id="chat-box"></div>
  
  <input type="text" id="message" placeholder="Escribe un mensaje..." />
  <button id="send">Enviar</button>

  <!-- CONTENEDOR DE CHATS PRIVADOS -->
  <div id="private-container">
    <h3>Chats Privados üí¨</h3>
    <div id="private-tabs"></div>
    <div id="private-chat-area"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
      authDomain: "chatarea-6170e.firebaseapp.com",
      projectId: "chatarea-6170e",
      storageBucket: "chatarea-6170e.firebasestorage.app",
      messagingSenderId: "147913199399",
      appId: "1:147913199399:web:886f09ab74017b3fc22302",
      databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userLat = 0, userLon = 0;
    let chatRadius = 1.0;
    let userRef = null;

    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("send");
    const radiusSelect = document.getElementById("radius");
    const genderSelect = document.getElementById("gender-select");
    const nickInput = document.getElementById("nickname");
    const tabsContainer = document.getElementById("private-tabs");
    const privateArea = document.getElementById("private-chat-area");

    const openChats = {}; // chatId -> { div, tab }

    // --- AUTENTICACI√ìN AN√ìNIMA ---
    auth.signInAnonymously().then(() => {
      const uid = auth.currentUser.uid;
      userRef = db.ref("usuarios/" + uid);
      document.getElementById("status").innerText = "Autenticado an√≥nimamente ‚úÖ";

      nickInput.addEventListener("change", () => {
        const nick = nickInput.value.trim();
        if (nick) userRef.update({ nick });
      });

      userRef.once("value").then(snap => {
        const data = snap.val();
        if (data) {
          if (data.radio) { chatRadius = data.radio; radiusSelect.value = chatRadius; }
          if (data.genero) { genderSelect.value = data.genero; }
          if (data.nick) { nickInput.value = data.nick; }
        }
        initLocation();
      });
    });

    // --- UBICACI√ìN ---
    function initLocation() {
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalizaci√≥n");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        document.getElementById("status").innerText +=
          ` | Ubicaci√≥n detectada (${userLat.toFixed(3)}, ${userLon.toFixed(3)})`;
        listenMessages();
      });
    }

    // --- GUARDAR RADIO / G√âNERO ---
    radiusSelect.addEventListener("change", () => {
      chatRadius = parseFloat(radiusSelect.value);
      if (userRef) userRef.update({ radio: chatRadius });
      chatBox.innerHTML = "";
      listenMessages();
    });

    genderSelect.addEventListener("change", () => {
      const genero = genderSelect.value;
      if (userRef) userRef.update({ genero });
    });

    // --- ENVIAR MENSAJE P√öBLICO ---
    sendBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      const msg = {
        text,
        timestamp: Date.now(),
        uid: auth.currentUser.uid,
        nick: nickInput.value.trim() || "Anon",
        lat: userLat,
        lon: userLon,
        gender: genderSelect.value
      };
      db.ref("mensajes").push(msg);
      input.value = "";
    });

    // --- ESCUCHAR MENSAJES ---
    function listenMessages() {
      const mensajesRef = db.ref("mensajes").orderByChild("timestamp");
      mensajesRef.off();
      mensajesRef.on("child_added", snap => {
        const msg = snap.val();
        const dist = getDistance(userLat, userLon, msg.lat, msg.lon);
        if (dist <= chatRadius) {
          const dateStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const genderIcon = msg.gender === "M" ? "‚ôÇÔ∏è" : msg.gender === "F" ? "‚ôÄÔ∏è" : "‚öß";
          const div = document.createElement("div");
          div.textContent = `[${dateStr}] ${genderIcon} ${msg.nick}: ${msg.text} (${dist.toFixed(2)} km)`;

          if (msg.uid !== auth.currentUser.uid) {
            const btn = document.createElement("button");
            btn.textContent = "Privado";
            btn.style.marginLeft = "10px";
            btn.onclick = () => openPrivateChat(msg.uid, msg.nick);
            div.appendChild(btn);
          }

          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });
    }

    // --- CALCULAR DISTANCIA ---
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) *
                Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // --- CHAT PRIVADO CON TABS ---
    function openPrivateChat(otherUid, otherNick) {
      const chatId = [auth.currentUser.uid, otherUid].sort().join("_");
      if (openChats[chatId]) return setActiveChat(chatId);

      // Crear pesta√±a
      const tab = document.createElement("div");
      tab.className = "tab";
      tab.textContent = otherNick || otherUid.slice(0, 5);
      const close = document.createElement("span");
      close.textContent = "‚ùå";
      close.onclick = e => {
        e.stopPropagation();
        removeChat(chatId);
      };
      tab.appendChild(close);
      tab.onclick = () => setActiveChat(chatId);
      tabsContainer.appendChild(tab);

      // Crear caja de mensajes
      const box = document.createElement("div");
      box.className = "private-chat-box";
      box.innerHTML = `<h4>Chat con ${otherNick || otherUid}</h4>`;
      const inputP = document.createElement("input");
      inputP.className = "private-input";
      inputP.placeholder = "Escribe un mensaje...";
      const sendP = document.createElement("button");
      sendP.textContent = "Enviar";
      box.appendChild(inputP);
      box.appendChild(sendP);
      privateArea.appendChild(box);

      const ref = db.ref("chatsPrivados/" + chatId);
      ref.on("child_added", s => {
        const m = s.val();
        const dateStr = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const genderIcon = m.gender === "M" ? "‚ôÇÔ∏è" : m.gender === "F" ? "‚ôÄÔ∏è" : "‚öß";
        const d = document.createElement("div");
        d.textContent = `[${dateStr}] ${genderIcon} ${m.nick}: ${m.text}`;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
      });

      sendP.onclick = () => {
        const text = inputP.value.trim();
        if (!text) return;
        ref.push({
          uid: auth.currentUser.uid,
          text,
          timestamp: Date.now(),
          gender: genderSelect.value,
          nick: nickInput.value.trim() || "Anon"
        });
        inputP.value = "";
      };

      openChats[chatId] = { div: box, tab };
      setActiveChat(chatId);
    }

    function setActiveChat(chatId) {
      Object.values(openChats).forEach(c => {
        c.div.style.display = "none";
        c.tab.classList.remove("active");
      });
      openChats[chatId].div.style.display = "block";
      openChats[chatId].tab.classList.add("active");
    }

    function removeChat(chatId) {
      openChats[chatId].div.remove();
      openChats[chatId].tab.remove();
      delete openChats[chatId];
      const keys = Object.keys(openChats);
      if (keys.length > 0) setActiveChat(keys[0]);
    }
  </script>
</body>
</html>
