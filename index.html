<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat por Zona üåé</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    #status { color: green; margin-bottom: 10px; }
    #private-container { border: 1px solid blue; margin-top: 10px; padding: 10px; display: none; }
    #private-tabs { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
    .tab {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 5px 10px;
      border-radius: 10px;
      cursor: pointer;
      position: relative;
    }
    .tab.active { background: #d0eaff; }
    .close-btn {
      color: red;
      font-weight: bold;
      margin-left: 5px;
      cursor: pointer;
    }
    .private-chat { display: none; border-top: 1px solid #ccc; padding-top: 5px; height: 200px; overflow-y: auto; }
    .private-chat.active { display: block; }
  </style>
</head>
<body>
  <h2>Chat P√∫blico por Zona üåé</h2>

  <label for="radius">Radio de visibilidad:</label>
  <select id="radius">
    <option value="1">1 km</option>
    <option value="5">5 km</option>
    <option value="10">10 km</option>
    <option value="50">50 km</option>
  </select>

  <br>
  <label for="gender">G√©nero:</label>
  <select id="gender-select">
    <option value="M">‚ôÇÔ∏è Masculino</option>
    <option value="F">‚ôÄÔ∏è Femenino</option>
    <option value="O">‚öß Otro</option>
  </select>
  
  <br>
  <label for="nickname">Nick:</label>
  <input type="text" id="nickname" placeholder="Tu apodo" />

  <div id="status">Conectando...</div>
  <div id="chat-box"></div>
  
  <input type="text" id="message" placeholder="Escribe un mensaje..." />
  <button id="send">Enviar</button>

  <div id="private-container">
    <h3>Chats Privados üí¨</h3>
    <div id="private-tabs"></div>
    <div id="private-chats"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
      authDomain: "chatarea-6170e.firebaseapp.com",
      projectId: "chatarea-6170e",
      storageBucket: "chatarea-6170e.firebasestorage.app",
      messagingSenderId: "147913199399",
      appId: "1:147913199399:web:886f09ab74017b3fc22302",
      databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userLat = 0, userLon = 0;
    let chatRadius = 1.0;
    let userRef = null;

    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("send");
    const radiusSelect = document.getElementById("radius");
    const genderSelect = document.getElementById("gender-select");
    const nickInput = document.getElementById("nickname");
    const privateContainer = document.getElementById("private-container");
    const privateTabs = document.getElementById("private-tabs");
    const privateChats = document.getElementById("private-chats");

    const privateChatsMap = {}; // guardar los chats abiertos

    auth.signInAnonymously()
      .then(() => {
        const uid = auth.currentUser.uid;
        userRef = db.ref("usuarios/" + uid);
        document.getElementById("status").innerText = "Autenticado an√≥nimamente ‚úÖ";

        nickInput.addEventListener("change", () => {
          const nick = nickInput.value.trim();
          if (nick) userRef.update({ nick });
        });

        userRef.once("value").then(snapshot => {
          const data = snapshot.val();
          if (data) {
            if (data.radio) { chatRadius = data.radio; radiusSelect.value = chatRadius; }
            if (data.genero) { genderSelect.value = data.genero; }
            if (data.nick) { nickInput.value = data.nick; }
          }
          initLocation();
        });
      })
      .catch(err => alert("Error al autenticar: " + err.message));

    function initLocation() {
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalizaci√≥n");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        document.getElementById("status").innerText +=
          ` | Ubicaci√≥n detectada (${userLat.toFixed(3)}, ${userLon.toFixed(3)})`;
        listenMessages();
      });
    }

    radiusSelect.addEventListener("change", () => {
      chatRadius = parseFloat(radiusSelect.value);
      if (userRef) userRef.update({ radio: chatRadius });
      chatBox.innerHTML = "";
      listenMessages();
    });

    genderSelect.addEventListener("change", () => {
      const genero = genderSelect.value;
      if (userRef) userRef.update({ genero });
    });

    sendBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      const gender = genderSelect.value;
      const nick = nickInput.value.trim() || "Anon";
      const msg = {
        text, timestamp: Date.now(),
        uid: auth.currentUser.uid,
        nick, lat: userLat, lon: userLon, gender
      };
      db.ref("mensajes").push(msg);
      input.value = "";
    });

    function listenMessages() {
      const mensajesRef = db.ref("mensajes").orderByChild("timestamp");
      mensajesRef.off();
      mensajesRef.on("child_added", snap => {
        const msg = snap.val();
        const dist = getDistance(userLat, userLon, msg.lat, msg.lon);
        if (dist <= chatRadius) {
          const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const genderIcon = msg.gender === "M" ? "‚ôÇÔ∏è" : msg.gender === "F" ? "‚ôÄÔ∏è" : "‚öß";
          const div = document.createElement("div");
          div.textContent = `[${time}] ${genderIcon} ${msg.nick}: ${msg.text} (${dist.toFixed(2)} km)`;

          if (msg.uid !== auth.currentUser.uid) {
            const btn = document.createElement("button");
            btn.textContent = "Privado";
            btn.style.marginLeft = "10px";
            btn.addEventListener("click", () => openPrivateChat(msg.uid, msg.nick));
            div.appendChild(btn);
          }

          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // -------- CHAT PRIVADO --------
    function openPrivateChat(otherUid, nick) {
      const chatId = [auth.currentUser.uid, otherUid].sort().join("_");

      if (!privateChatsMap[chatId]) {
        privateContainer.style.display = "block";

        // Crear pesta√±a
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.textContent = nick || otherUid;

        // Bot√≥n de cerrar
        const close = document.createElement("span");
        close.textContent = "‚úñ";
        close.className = "close-btn";
        close.onclick = (e) => {
          e.stopPropagation();
          db.ref("chatsPrivados/" + chatId).remove();
          delete privateChatsMap[chatId];
          tab.remove();
          chatDiv.remove();
          if (!Object.keys(privateChatsMap).length) privateContainer.style.display = "none";
        };
        tab.appendChild(close);

        // Crear contenido del chat
        const chatDiv = document.createElement("div");
        chatDiv.className = "private-chat";
        chatDiv.innerHTML = `<div><strong>Chat con ${nick || otherUid}</strong></div>`;
        const msgContainer = document.createElement("div");
        chatDiv.appendChild(msgContainer);

        const input = document.createElement("input");
        input.placeholder = "Escribe un mensaje...";
        chatDiv.appendChild(input);
        const sendBtn = document.createElement("button");
        sendBtn.textContent = "Enviar";
        chatDiv.appendChild(sendBtn);

        privateTabs.appendChild(tab);
        privateChats.appendChild(chatDiv);
        privateChatsMap[chatId] = { tab, chatDiv };

        // Cambiar de pesta√±a
        tab.onclick = () => {
          Object.values(privateChatsMap).forEach(c => {
            c.tab.classList.remove("active");
            c.chatDiv.classList.remove("active");
          });
          tab.classList.add("active");
          chatDiv.classList.add("active");
        };
        tab.click(); // activa al crearla

        // Escuchar mensajes
        const ref = db.ref("chatsPrivados/" + chatId).orderByChild("timestamp");
        ref.on("child_added", s => {
          const m = s.val();
          const time = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const genderIcon = m.gender === "M" ? "‚ôÇÔ∏è" : m.gender === "F" ? "‚ôÄÔ∏è" : "‚öß";
          const line = document.createElement("div");
          line.textContent = `[${time}] ${genderIcon} ${m.nick}: ${m.text}`;
          msgContainer.appendChild(line);
          msgContainer.scrollTop = msgContainer.scrollHeight;
        });

        sendBtn.onclick = () => {
          const text = input.value.trim();
          if (!text) return;
          const gender = genderSelect.value;
          const nick = nickInput.value.trim() || "Anon";
          db.ref("chatsPrivados/" + chatId).push({
            uid: auth.currentUser.uid,
            text, timestamp: Date.now(), gender, nick
          });
          input.value = "";
        };
      }

      // Mostrar si ya existe
      privateChatsMap[chatId].tab.click();
    }
  </script>
</body>
</html>
