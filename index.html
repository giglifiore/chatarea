<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat por Zona üåé</title>
  <style>
    body { font-family: Arial; margin: 20px; display: flex; flex-direction: column;align-items: center; gap: 20px; }
    #main-chat { flex: 2; }
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    #status { color: green; margin-bottom: 10px; }
    #private-chat-area { flex: 1; border: 1px solid blue; padding: 10px; height: 400px; overflow-y: auto; }
    .private-tab { border: 1px solid #aaa; border-radius: 8px; padding: 5px; margin-bottom: 8px; cursor: pointer; background: #f7f7f7; }
    .private-tab:hover { background: #e8f0ff; }
    .private-chat { display: none; border: 1px solid #ccc; padding: 8px; border-radius: 8px; background: #f9f9f9; }
    .active { display: block !important; }
    button.delete-btn { background: red; color: white; border: none; padding: 4px 6px; cursor: pointer; margin-left: 8px; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="main-chat">
    <h2>Chat P√∫blico por Zona üåé</h2>

    <label for="radius">Radio de visibilidad:</label>
    <select id="radius">
      <option value="1">1 km</option>
      <option value="5">5 km</option>
      <option value="10">10 km</option>
      <option value="50">50 km</option>
    </select>

    <br>
    <label for="gender">G√©nero:</label>
    <select id="gender-select">
      <option value="M">‚ôÇÔ∏è Masculino</option>
      <option value="F">‚ôÄÔ∏è Femenino</option>
      <option value="O">‚öß Otro</option>
    </select>

    <br>
    <label for="nickname">Nick:</label>
    <input type="text" id="nickname" placeholder="Tu apodo" />

    <div id="status">Conectando...</div>
    <div id="chat-box"></div>

    <input type="text" id="message" placeholder="Escribe un mensaje..." />
    <button id="send">Enviar</button>
  </div>

  <!-- üü¶ Secci√≥n siempre visible de chats privados -->
  <div id="private-chat-area">
    <h3>Chats Privados üí¨</h3>
    <div id="private-tabs"></div>
    <div id="private-boxes"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
      authDomain: "chatarea-6170e.firebaseapp.com",
      projectId: "chatarea-6170e",
      storageBucket: "chatarea-6170e.firebasestorage.app",
      messagingSenderId: "147913199399",
      appId: "1:147913199399:web:886f09ab74017b3fc22302",
      databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userLat = 0, userLon = 0;
    let chatRadius = 1.0;
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("send");
    const radiusSelect = document.getElementById("radius");
    const genderSelect = document.getElementById("gender-select");
    const privateTabs = document.getElementById("private-tabs");
    const privateBoxes = document.getElementById("private-boxes");

    let userRef = null;
    let currentUser = null;

    auth.signInAnonymously()
      .then(() => {
        currentUser = auth.currentUser;
        userRef = db.ref("usuarios/" + currentUser.uid);
        document.getElementById("status").innerText = "Autenticado ‚úÖ";
        initLocation();
        listenPrivateChats();
      })
      .catch(err => alert("Error al autenticar: " + err.message));

    function initLocation() {
      if (!navigator.geolocation) {
        alert("Tu navegador no soporta geolocalizaci√≥n");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        document.getElementById("status").innerText +=
          ` | Ubicaci√≥n (${userLat.toFixed(3)}, ${userLon.toFixed(3)})`;
        listenMessages();
      }, err => alert("Error de ubicaci√≥n: " + err.message));
    }

    sendBtn.addEventListener("click", () => {
      const text = input.value.trim();
      if (!text) return;
      const nick = document.getElementById("nickname").value.trim() || "Anon";
      const msg = {
        text,
        timestamp: Date.now(),
        uid: currentUser.uid,
        nick,
        lat: userLat,
        lon: userLon,
        gender: genderSelect.value
      };
      db.ref("mensajes").push(msg);
      input.value = "";
    });

    function listenMessages() {
      const mensajesRef = db.ref("mensajes").orderByChild("timestamp");
      mensajesRef.off();
      mensajesRef.on("child_added", snap => {
        const msg = snap.val();
        const dist = getDistance(userLat, userLon, msg.lat, msg.lon);
        if (dist <= chatRadius) {
          const div = document.createElement("div");
          const dateStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const genderIcon = msg.gender === "M" ? "‚ôÇÔ∏è" : msg.gender === "F" ? "‚ôÄÔ∏è" : "‚öß";
          div.textContent = `[${dateStr}] ${genderIcon} ${msg.nick}: ${msg.text} (${dist.toFixed(2)} km)`;

          if (msg.uid !== currentUser.uid) {
            const btn = document.createElement("button");
            btn.textContent = "Privado";
            btn.style.marginLeft = "10px";
            btn.onclick = () => openPrivateChat(msg.uid, msg.nick);
            div.appendChild(btn);
          }

          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function listenPrivateChats() {
      const privateRef = db.ref("chatsPrivados");
      privateRef.on("child_added", snap => {
        const chatId = snap.key;
        if (chatId.includes(currentUser.uid)) {
          const parts = chatId.split("_");
          const otherUid = parts.find(u => u !== currentUser.uid);
          addPrivateTab(chatId, otherUid);
        }
      });
    }

    function addPrivateTab(chatId, otherUid) {
      if (document.getElementById(`tab-${chatId}`)) return;

      const tab = document.createElement("div");
      tab.id = `tab-${chatId}`;
      tab.className = "private-tab";
      tab.textContent = `Chat con ${otherUid}`;

      const delBtn = document.createElement("button");
      delBtn.textContent = "üóëÔ∏è";
      delBtn.className = "delete-btn";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm("¬øEliminar este chat privado?")) {
          db.ref("chatsPrivados/" + chatId).remove();
          tab.remove();
          const box = document.getElementById(`box-${chatId}`);
          if (box) box.remove();
        }
      };

      tab.appendChild(delBtn);
      tab.onclick = () => showPrivateChat(chatId, otherUid);
      privateTabs.appendChild(tab);

      // Crear contenedor de chat
      const box = document.createElement("div");
      box.id = `box-${chatId}`;
      box.className = "private-chat";
      privateBoxes.appendChild(box);
    }

    function showPrivateChat(chatId, otherUid) {
      document.querySelectorAll(".private-chat").forEach(b => b.classList.remove("active"));
      const box = document.getElementById(`box-${chatId}`);
      box.classList.add("active");
      box.innerHTML = `<h4>Chat con ${otherUid}</h4>`;

      const msgList = document.createElement("div");
      msgList.style.maxHeight = "200px";
      msgList.style.overflowY = "auto";
      box.appendChild(msgList);

      const input = document.createElement("input");
      input.placeholder = "Mensaje...";
      const btn = document.createElement("button");
      btn.textContent = "Enviar";
      box.appendChild(input);
      box.appendChild(btn);

      const refRead = db.ref("chatsPrivados/" + chatId).orderByChild("timestamp");
      const refWrite = db.ref("chatsPrivados/" + chatId);

      refRead.off();
      refRead.on("child_added", snap => {
        const m = snap.val();
        const dateStr = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const div = document.createElement("div");
        div.textContent = `[${dateStr}] ${m.uid}: ${m.text}`;
        msgList.appendChild(div);
        msgList.scrollTop = msgList.scrollHeight;
      });

      btn.onclick = () => {
        const text = input.value.trim();
        if (!text) return;
        refWrite.push({
          uid: currentUser.uid,
          text,
          timestamp: Date.now()
        });
        input.value = "";
      };
    }
  </script>
</body>
</html>
