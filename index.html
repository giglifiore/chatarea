<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat por Zona üåé</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    #status { color: green; margin-bottom: 10px; }
    #private-chats { margin-top: 20px; }
    .private-tab { display: inline-block; padding: 5px 10px; margin-right: 5px; background: #e8f0ff; border-radius: 5px; cursor: pointer; position: relative; }
    .private-tab .close-btn { position: absolute; top: 0; right: 0; font-size: 12px; background: red; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; line-height: 12px; padding: 0; }
    .private-chat { display: none; border: 1px solid #ccc; padding: 8px; border-radius: 8px; background: #f9f9f9; margin-top: 5px; max-height: 200px; overflow-y: auto; }
    .private-chat.active { display: block; }
    .private-input { width: 70%; }
  </style>
</head>
<body>
  <h2>Chat P√∫blico por Zona üåé</h2>
  
  <label for="radius">Radio de visibilidad:</label>
  <select id="radius">
    <option value="1">1 km</option>
    <option value="5">5 km</option>
    <option value="10">10 km</option>
    <option value="50">50 km</option>
  </select>

  <br>
  <label for="gender">G√©nero:</label>
  <select id="gender-select">
    <option value="M">‚ôÇÔ∏è Masculino</option>
    <option value="F">‚ôÄÔ∏è Femenino</option>
    <option value="O">‚öß Otro</option>
  </select>

  <br>
  <label for="nickname">Nick:</label>
  <input type="text" id="nickname" placeholder="Tu apodo" />

  <div id="status">Conectando...</div>
  <div id="chat-box"></div>
  
  <input type="text" id="message" placeholder="Escribe un mensaje..." />
  <button id="send">Enviar</button>

  <!-- Secci√≥n de chats privados -->
  <div id="private-chats">
    <h3>Chats Privados üí¨</h3>
    <div id="private-tabs"></div>
    <div id="private-boxes"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
      authDomain: "chatarea-6170e.firebaseapp.com",
      projectId: "chatarea-6170e",
      storageBucket: "chatarea-6170e.firebasestorage.app",
      messagingSenderId: "147913199399",
      appId: "1:147913199399:web:886f09ab74017b3fc22302",
      databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userLat = 0, userLon = 0, chatRadius = 1.0;
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("send");
    const radiusSelect = document.getElementById("radius");
    const genderSelect = document.getElementById("gender-select");
    const nickInput = document.getElementById("nickname");

    const privateTabs = document.getElementById("private-tabs");
    const privateBoxes = document.getElementById("private-boxes");

    let userRef = null, currentUser = null;
    const privateChats = {}; // Guardar referencia a chats privados abiertos

    auth.signInAnonymously()
      .then(() => {
        currentUser = auth.currentUser;
        userRef = db.ref("usuarios/" + currentUser.uid);
        document.getElementById("status").innerText = "Autenticado an√≥nimamente ‚úÖ";

        nickInput.addEventListener("change", () => {
          const nick = nickInput.value.trim();
          if (nick) userRef.update({ nick });
        });

        userRef.once("value").then(snapshot => {
          const data = snapshot.val();
          if (data) {
            if (data.radio) { chatRadius = data.radio; radiusSelect.value = chatRadius; }
            if (data.genero) { genderSelect.value = data.genero; }
            if (data.nick) { nickInput.value = data.nick; }
          }
          initLocation();
          listenPrivateChats();
        });
      });

    function initLocation() {
      if (!navigator.geolocation) { alert("No soporta geolocalizaci√≥n"); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;
        document.getElementById("status").innerText +=
          ` | Ubicaci√≥n (${userLat.toFixed(3)}, ${userLon.toFixed(3)})`;
        listenMessages();
      });
    }

    sendBtn.addEventListener("click", () => {
      const text = input.value.trim(); if (!text) return;
      const nick = nickInput.value.trim() || "Anon";
      db.ref("mensajes").push({
        text,
        timestamp: Date.now(),
        uid: currentUser.uid,
        nick,
        lat: userLat,
        lon: userLon,
        gender: genderSelect.value
      });
      input.value = "";
    });

    function listenMessages() {
      const mensajesRef = db.ref("mensajes").orderByChild("timestamp");
      mensajesRef.off();
      mensajesRef.on("child_added", snap => {
        const msg = snap.val();
        const dist = getDistance(userLat,userLon,msg.lat,msg.lon);
        if(dist <= chatRadius){
          const dateStr = new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          const genderIcon = msg.gender==='M'?'‚ôÇÔ∏è':msg.gender==='F'?'‚ôÄÔ∏è':'‚öß';
          const div = document.createElement("div");
          div.textContent = `[${dateStr}] ${genderIcon} ${msg.nick}: ${msg.text} (${dist.toFixed(2)} km)`;
          if(msg.uid !== currentUser.uid){
            const btn = document.createElement("button");
            btn.textContent = "Privado";
            btn.style.marginLeft="10px";
            btn.onclick = ()=>openPrivateChat(msg.uid,msg.nick);
            div.appendChild(btn);
          }
          chatBox.appendChild(div);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      });
    }

    function getDistance(lat1, lon1, lat2, lon2){
      const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function listenPrivateChats(){
      const privateRef = db.ref("chatsPrivados");
      privateRef.on("child_added", snap=>{
        const chatId = snap.key;
        if(chatId.includes(currentUser.uid)){
          const otherUid = chatId.replace(currentUser.uid,'').replace('_','');
          openPrivateChat(otherUid);
        }
      });
    }

    function openPrivateChat(otherUid, otherNick){
      const chatId = [currentUser.uid,otherUid].sort().join("_");
      if(privateChats[chatId]) return; // Ya abierto

      // Crear pesta√±a
      const tab = document.createElement("div");
      tab.className = "private-tab";
      tab.textContent = `Chat: ${otherNick || otherUid}`;
      const closeBtn = document.createElement("button");
      closeBtn.className="close-btn";
      closeBtn.textContent="√ó";
      closeBtn.onclick = e=>{
        e.stopPropagation();
        privateBoxes.removeChild(privateChats[chatId].box);
        privateTabs.removeChild(tab);
        delete privateChats[chatId];
      };
      tab.appendChild(closeBtn);
      tab.onclick = ()=>showChat(chatId);
      privateTabs.appendChild(tab);

      // Crear caja de chat
      const box = document.createElement("div");
      box.className="private-chat active";
      privateBoxes.appendChild(box);

      const inputPriv = document.createElement("input");
      inputPriv.className="private-input";
      inputPriv.placeholder="Mensaje...";
      const btnSend = document.createElement("button");
      btnSend.textContent="Enviar";
      box.appendChild(inputPriv); box.appendChild(btnSend);

      // Escuchar mensajes
      const refRead = db.ref("chatsPrivados/"+chatId).orderByChild("timestamp");
      refRead.on("child_added", snap=>{
        const m = snap.val();
        const dateStr = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        const msgDiv = document.createElement("div");
        msgDiv.textContent = `[${dateStr}] ${m.nick || "Anon"}: ${m.text}`;
        box.appendChild(msgDiv);
        box.scrollTop = box.scrollHeight;
      });

      btnSend.onclick = ()=>{
        const text = inputPriv.value.trim(); if(!text) return;
        db.ref("chatsPrivados/"+chatId).push({uid:currentUser.uid,nick:nickInput.value||"Anon",text,timestamp:Date.now()});
        inputPriv.value="";
      };

      privateChats[chatId] = {tab, box};
      showChat(chatId);
    }

    function showChat(chatId){
      Object.values(privateChats).forEach(c=>c.box.classList.remove("active"));
      privateChats[chatId].box.classList.add("active");
    }
  </script>
</body>
</html>
