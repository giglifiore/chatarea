<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat PÃºblico y Privado</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f3f4f6;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }

    h2 {
      margin: 10px 0;
      color: #333;
    }

    .chat-container {
      width: 100%;
      max-width: 450px;
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    #messages, .private-chat {
      height: 250px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
    }

    .message {
      padding: 8px;
      margin: 5px 0;
      border-radius: 10px;
      background: #e5e7eb;
    }

    .message.self {
      background: #4f46e5;
      color: white;
      text-align: right;
    }

    .controls {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }

    input, select, button {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      flex: 1;
    }

    button {
      background: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #4338ca;
    }

    /* Privado */
    .private-container {
      position: relative;
      width: 100%;
      max-width: 450px;
    }

    .private-chat {
      display: none;
      flex-direction: column;
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
    }

    .private-chat.active {
      display: flex;
    }

    .close-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ef4444;
      color: white;
      border: none;
      font-size: 12px;
      cursor: pointer;
      line-height: 20px;
    }

    @media (max-width: 600px) {
      .chat-container, .private-chat {
        width: 95%;
      }
    }
  </style>
</head>
<body>

  <h2>ðŸ’¬ Chat PÃºblico</h2>
  <div class="chat-container">
    <div id="messages"></div>
    <div class="controls">
      <input id="nickInput" type="text" placeholder="Tu Nick" />
      <select id="genderSelect">
        <option value="ðŸ‘¨">ðŸ‘¨</option>
        <option value="ðŸ‘©">ðŸ‘©</option>
      </select>
    </div>
    <div class="controls">
      <input id="messageInput" type="text" placeholder="Escribe un mensaje..." />
      <button id="btnSend">Enviar</button>
    </div>
  </div>

  <h2>ðŸ’Œ Chat Privado</h2>
  <div class="private-container" id="privateChats"></div>

  <script>
    // ðŸ”¥ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSy...",
      authDomain: "chatarea-6170e.firebaseapp.com",
      databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com",
      projectId: "chatarea-6170e",
      storageBucket: "chatarea-6170e.appspot.com",
      messagingSenderId: "147913199399",
      appId: "1:147913199399:web:886f09a..."
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const messagesRef = db.ref("messages");
    const privateChatsContainer = document.getElementById("privateChats");

    const nickInput = document.getElementById("nickInput");
    const genderSelect = document.getElementById("genderSelect");
    const messageInput = document.getElementById("messageInput");
    const btnSend = document.getElementById("btnSend");
    const messagesDiv = document.getElementById("messages");

    let currentNick = localStorage.getItem("nick") || "";
    let currentGender = localStorage.getItem("gender") || "ðŸ‘¨";
    if (currentNick) nickInput.value = currentNick;
    genderSelect.value = currentGender;

    nickInput.addEventListener("input", () => {
      localStorage.setItem("nick", nickInput.value);
      currentNick = nickInput.value;
    });

    genderSelect.addEventListener("change", () => {
      localStorage.setItem("gender", genderSelect.value);
      currentGender = genderSelect.value;
    });

    btnSend.onclick = () => {
      const text = messageInput.value.trim();
      if (!text || !currentNick) return alert("Escribe tu nick y mensaje.");
      const msg = {
        nick: currentNick,
        gender: currentGender,
        text: text,
        timestamp: Date.now()
      };
      messagesRef.push(msg);
      messageInput.value = "";
    };

    messagesRef.on("child_added", (snap) => {
      const msg = snap.val();
      const div = document.createElement("div");
      const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      div.className = "message" + (msg.nick === currentNick ? " self" : "");
      div.innerHTML = `<b>${msg.gender} ${msg.nick}</b> [${time}]: ${msg.text>`;
      div.onclick = () => openPrivateChat(msg.nick, msg.gender);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    const privateChats = {};

    function openPrivateChat(nick, gender) {
      if (nick === currentNick) return;

      // Oculta todos los demÃ¡s
      Object.values(privateChats).forEach(chat => chat.element.classList.remove("active"));

      if (!privateChats[nick]) {
        const chatDiv = document.createElement("div");
        chatDiv.className = "private-chat active";
        chatDiv.innerHTML = `
          <button class="close-btn" onclick="closePrivateChat('${nick}')">Ã—</button>
          <h3>${gender} ${nick}</h3>
          <div class="private-messages" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
          <div style="display:flex; gap:5px;">
            <input type="text" placeholder="Mensaje privado a ${nick}" />
            <button>Enviar</button>
          </div>
        `;
        privateChatsContainer.appendChild(chatDiv);

        const input = chatDiv.querySelector("input");
        const button = chatDiv.querySelector("button:last-of-type");
        const msgBox = chatDiv.querySelector(".private-messages");

        const chatKey = [currentNick, nick].sort().join("_");
        const ref = db.ref("private/" + chatKey);

        ref.on("child_added", snap => {
          const msg = snap.val();
          const p = document.createElement("div");
          const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          p.textContent = `${msg.nick} [${time}]: ${msg.text}`;
          msgBox.appendChild(p);
          msgBox.scrollTop = msgBox.scrollHeight;
        });

        button.onclick = () => {
          if (input.value.trim()) {
            ref.push({
              nick: currentNick,
              text: input.value.trim(),
              timestamp: Date.now()
            });
            input.value = "";
          }
        };

        privateChats[nick] = { element: chatDiv, ref };
      } else {
        privateChats[nick].element.classList.add("active");
      }
    }

    function closePrivateChat(nick) {
      if (privateChats[nick]) {
        privateChats[nick].element.remove();
        delete privateChats[nick];
      }
    }

    window.closePrivateChat = closePrivateChat;
  </script>
</body>
</html>
